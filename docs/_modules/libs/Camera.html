<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>libs.Camera &#8212; SPC-EyePi 3.2 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SPC-EyePi</a></h1>



<p class="blurb">Capture/Control software for DSLRs, USB cameras, and the Raspberry Pi camera.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=borevitzlab&repo=spc-eyepi&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ansible.html">Ansible Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for libs.Camera</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="k">import</span> <span class="n">HTTPBasicAuth</span>
<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="k">import</span> <span class="n">ElementTree</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Lock</span>
<span class="kn">from</span> <span class="nn">libs.SysUtil</span> <span class="k">import</span> <span class="n">SysUtil</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fileConfig</span><span class="p">(</span><span class="s2">&quot;logging.ini&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;paramiko&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># improt yaml module and assert that it has a load function</span>
    <span class="kn">import</span> <span class="nn">yaml</span>

    <span class="k">assert</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldnt import suitable yaml module, no IP camera support: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gphoto2cffi</span> <span class="k">as</span> <span class="nn">gp</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldnt import gphoto2-cffi module, no DSLR support: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">picamera</span>
    <span class="kn">import</span> <span class="nn">picamera.array</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldnt import picamera module, no picamera camera support: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">pass</span>

<span class="n">USBDEVFS_RESET</span> <span class="o">=</span> <span class="mi">21780</span>


<div class="viewcode-block" id="nested_lookup"><a class="viewcode-back" href="../../libs.html#libs.Camera.nested_lookup">[docs]</a><span class="k">def</span> <span class="nf">nested_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    nested document lookup,</span>
<span class="sd">    works on dicts and lists</span>
<span class="sd">    :param key: string of key to lookup</span>
<span class="sd">    :param document: dict or list to lookup</span>
<span class="sd">    :return: yields item</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">nested_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">result</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">nested_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">result</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">nested_lookup</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Camera"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera">[docs]</a><span class="k">class</span> <span class="nc">Camera</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base Camera class.</span>

<span class="sd">    :cvar int accuracy: 3: Number of seconds caputre should be accurate to.</span>
<span class="sd">    :cvar int default_width: 1080: Default width of resized images.</span>
<span class="sd">    :cvar int default_height: 720: Default height of resuzed images.</span>
<span class="sd">    :cvar list file_types: [&quot;CR2&quot;, &quot;RAW&quot;, &quot;NEF&quot;, &quot;JPG&quot;, &quot;JPEG&quot;, &quot;PPM&quot;, &quot;TIF&quot;, &quot;TIFF&quot;]: Supported output image types.</span>
<span class="sd">    :cvar list output_types: [&quot;tif&quot;, &quot;jpg&quot;]: Output image types, ignored by GPCamera.</span>

<span class="sd">    :ivar collections.deque communication_queue: Reference to a deque, or a deque.</span>
<span class="sd">    :ivar logging.Logger logger: Logger for each Camera.</span>
<span class="sd">    :ivar threading.Event stopper: Stopper event object to allow thread stopping.</span>
<span class="sd">    :ivar str identifier: Unique identifier for the camera. Used to distinguish cameras from one another.</span>
<span class="sd">    :ivar list failed: List of failed capture timepoints.</span>
<span class="sd">    :ivar str config_filename: Confuguration file path, unused if camera is instantiated with the noconf init parameter.</span>
<span class="sd">    :ivar configparser.ConfigParser config: Configuration object.</span>
<span class="sd">    :ivar str camera_name: Human friendly name of the camera.</span>
<span class="sd">    :ivar int interval: Capture interval (in seconds).</span>
<span class="sd">    :ivar str spool_directory: Path to stream images into during the capture process.</span>
<span class="sd">    :ivar str upload_directory: Path to move images to after the captre process.</span>
<span class="sd">    :ivar datetime.time begin_capture: Naive start time for capture.</span>
<span class="sd">    :ivar datetime.time end_capture: Naive end time for capture.</span>
<span class="sd">    :ivar datetime.datetime current_capture_time: When the capture process began.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">default_width</span><span class="p">,</span> <span class="n">default_height</span> <span class="o">=</span> <span class="mi">1080</span><span class="p">,</span> <span class="mi">720</span>
    <span class="n">file_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CR2&quot;</span><span class="p">,</span> <span class="s2">&quot;RAW&quot;</span><span class="p">,</span> <span class="s2">&quot;NEF&quot;</span><span class="p">,</span> <span class="s2">&quot;JPG&quot;</span><span class="p">,</span> <span class="s2">&quot;JPEG&quot;</span><span class="p">,</span> <span class="s2">&quot;PPM&quot;</span><span class="p">,</span> <span class="s2">&quot;TIF&quot;</span><span class="p">,</span> <span class="s2">&quot;TIFF&quot;</span><span class="p">]</span>
    <span class="n">output_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tif&quot;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">]</span>

    <span class="n">_frame</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_thread</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_last_access</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Camera.init_stream"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.init_stream">[docs]</a>    <span class="k">def</span> <span class="nf">init_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialises a video stream class thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_thread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># start background frame thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stream_thread</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="c1"># wait until frames start to be available</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span></div>

<div class="viewcode-block" id="Camera.get_frame"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.get_frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a frame from the a running :func:`stream_thread`.</span>

<span class="sd">        :return: encoded image data as bytes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_last_access</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_stream</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_frame</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Camera.stream_thread"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.stream_thread">[docs]</a>    <span class="k">def</span> <span class="nf">stream_thread</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Boilerplate stream thread.</span>
<span class="sd">        Override this with the correct method of opening the camera, grabbing image data and closing the camera.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unimplemented classmethod call: stream_thread&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You should not create a Camera object directly&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_camera</span><span class="p">():</span>
            <span class="k">pass</span>

        <span class="k">with</span> <span class="n">get_camera</span><span class="p">()</span> <span class="k">as</span> <span class="n">camera</span><span class="p">:</span>
            <span class="c1"># let camera warm up</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># example, you actually need to get the data from somewhere.</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># if there hasn&#39;t been any clients asking for frames in</span>
                <span class="c1"># the last 10 seconds stop the thread</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_last_access</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="p">:</span> <span class="n">deque</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">noconf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialiser for cameras...</span>

<span class="sd">        :param identifier: unique identified for this camera, MANDATORY</span>
<span class="sd">        :param queue: deque to push info into</span>
<span class="sd">        :param noconf: dont create a config, or watch anything. Used for temporarily streaming from a camera</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">communication_queue</span> <span class="o">=</span> <span class="n">queue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopper</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orinal_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exif</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Camera</span><span class="o">.</span><span class="n">default_width</span><span class="p">,</span> <span class="n">Camera</span><span class="o">.</span><span class="n">default_height</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">noconf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span> <span class="o">=</span> <span class="n">SysUtil</span><span class="o">.</span><span class="n">identifier_to_ini</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">camera_name</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">spool_directory</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_init</span><span class="p">()</span>

<div class="viewcode-block" id="Camera.re_init"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.re_init">[docs]</a>    <span class="k">def</span> <span class="nf">re_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-initialisation method for updating configuration values.</span>

<span class="sd">        The signature for this method is provided to :func:`libs.SysUtil.SysUtil.add_watch`, which calls it</span>
<span class="sd">        when the config file has been modified.</span>

<span class="sd">        This method should load all the configuration values from the config file into the Camera object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Re-init...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">SysUtil</span><span class="o">.</span><span class="n">ensure_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">camera_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;camera&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;timelapse&quot;</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spool_directory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="s2">&quot;SPC-EYEPI_&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;localfiles&quot;</span><span class="p">][</span><span class="s2">&quot;upload_dir&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">)</span>

        <span class="n">start_time_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;timelapse&#39;</span><span class="p">][</span><span class="s1">&#39;starttime&#39;</span><span class="p">])</span>
        <span class="n">start_time_string</span> <span class="o">=</span> <span class="n">start_time_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">end_time_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;timelapse&#39;</span><span class="p">][</span><span class="s1">&#39;stoptime&#39;</span><span class="p">])</span>
        <span class="n">end_time_string</span> <span class="o">=</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start_time_string</span> <span class="o">=</span> <span class="n">start_time_string</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="s2">&quot;Non numerical start time, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_time_string</span><span class="p">,</span> <span class="s2">&quot;%H%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Time conversion error starttime - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># cut string to max of 4.</span>
            <span class="n">end_time_string</span> <span class="o">=</span> <span class="n">end_time_string</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="s2">&quot;Non numerical end time, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">,</span> <span class="s2">&quot;%H%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Time conversion error stoptime - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating upload dir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Creating directories </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exif_fields</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera.capture_image"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.capture_image">[docs]</a>    <span class="k">def</span> <span class="nf">capture_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Camera capture method.</span>
<span class="sd">        override this method when creating a new type of camera.</span>

<span class="sd">        Behavior:</span>
<span class="sd">            - if filename is a string, write images to disk as filename.ext, and return the names of the images written sucessfully.</span>
<span class="sd">            - if filename is None, it will set the instance attribute `_image` to a numpy array of the image and return that.</span>

<span class="sd">        :param filename: image filename without extension</span>
<span class="sd">        :return: :func:`numpy.array` if filename not specified, otherwise list of files.</span>
<span class="sd">        :rtype: numpy.array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span></div>

<div class="viewcode-block" id="Camera.capture"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.capture">[docs]</a>    <span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        capture method, only extends functionality of :func:`Camera.capture` so that testing with  can happen</span>

<span class="sd">        Camera.capture = Camera.capture_monkey</span>
<span class="sd">        For extending the Camera class override the Camera.capture_image method, not this one.</span>

<span class="sd">        :param filename: image filename without extension</span>
<span class="sd">        :return: :func:`numpy.array` if filename not specified, otherwise list of files.</span>
<span class="sd">        :rtype: numpy.array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture_image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Camera.capture_monkey"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.capture_monkey">[docs]</a>    <span class="k">def</span> <span class="nf">capture_monkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates things going horribly wrong with the capture.</span>
<span class="sd">        Will sometimes return None, an empty list or an invalid filename.</span>
<span class="sd">        Sometimes will raise a generic Exception.</span>
<span class="sd">        The rest of the time it will capture a valid image.</span>

<span class="sd">        :param filename: image filename without extension</span>
<span class="sd">        :return: :func:`numpy.array` if filename not specified, otherwise list of files.</span>
<span class="sd">        :rtype: numpy.array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Capturing with a naughty monkey.&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="c1"># return nothing</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="mi">10</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="c1"># return empty list</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="mi">20</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">:</span>
            <span class="c1"># return an invalid list of no files</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Ooh ooh, ahh ahhh!&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="mi">30</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">:</span>
            <span class="c1"># raise an uncaught exception</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;BANANAS&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="mi">40</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="c1"># return some random bytes</span>
            <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="c1"># return a string</span>
            <span class="k">return</span> <span class="s2">&quot;Feed me!&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture_image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exif</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the current exif data, sets the exif datetime field to now.</span>

<span class="sd">        :return: dictionary of exif fields and their values.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exif</span><span class="p">[</span><span class="s2">&quot;Exif.Photo.DateTimeOriginal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exif</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the current image (last image taken and stored) as a numpy.array.</span>

<span class="sd">        :return: numpy array of the currently stored image.</span>
<span class="sd">        :rtype: numpy.array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Camera.timestamp"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.timestamp">[docs]</a>    <span class="k">def</span> <span class="nf">timestamp</span><span class="p">(</span><span class="n">tn</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a properly formatted timestamp from a datetime object.</span>

<span class="sd">        :param tn: datetime to format to timestream timestamp string</span>
<span class="sd">        :return: formatted timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">tn</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">_%H_%M_%S&#39;</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Camera.time2seconds"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.time2seconds">[docs]</a>    <span class="k">def</span> <span class="nf">time2seconds</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a datetime to an integer of seconds since epoch</span>

<span class="sd">        :return: integer of seconds since 1970-01-01</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># the &#39;timestamp()&#39; method is only implemented in python3.3`</span>
            <span class="c1"># this is an old compatibility thing</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">second</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timestamped_imagename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a timestamped image basename without extension from :func:`Camera.current_capture_time`</span>

<span class="sd">        :return: image basename</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{camera_name}</span><span class="s1">_</span><span class="si">{timestamp}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">camera_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_name</span><span class="p">,</span>
                                                  <span class="n">timestamp</span><span class="o">=</span><span class="n">Camera</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_to_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters out times for capture.</span>

<span class="sd">        returns True by default.</span>

<span class="sd">        returns False if the conditions where the camera should capture are NOT met.</span>

<span class="sd">        :return: whether or not it is time to capture</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_naive_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;enabled&quot;</span><span class="p">):</span>
            <span class="c1"># if the camera is disabled, never take photos</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span><span class="p">:</span>
            <span class="c1"># where the start capture time is less than the end capture time</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">&lt;=</span> <span class="n">current_naive_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># where the start capture time is greater than the end capture time</span>
            <span class="c1"># i.e. capturing across midnight.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">&lt;=</span> <span class="n">current_naive_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># capture interval</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time2seconds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">&lt;</span> <span class="n">Camera</span><span class="o">.</span><span class="n">accuracy</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Camera.get_exif_fields"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.get_exif_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_exif_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get default fields for exif dict, this should be overriden and super-ed if you want to add custom exif tags.</span>

<span class="sd">        :return: exif fields</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exif</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Image.Make&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Make&quot;</span>
        <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Image.Model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Model&quot;</span>
        <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Image.CameraSerialNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span>
        <span class="k">return</span> <span class="n">exif</span></div>

<div class="viewcode-block" id="Camera.encode_write_np_array"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.encode_write_np_array">[docs]</a>    <span class="k">def</span> <span class="nf">encode_write_np_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">np_image_array</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        takes a RGB numpy image array like the ones from cv2 and writes it to disk as a tif and jpg</span>
<span class="sd">        converts from rgb to bgr for cv2 so that the images save correctly</span>
<span class="sd">        also tries to add exif data to the images</span>

<span class="sd">        :param numpy.array np_image_array: 3 dimensional image array, x,y,rgb</span>
<span class="sd">        :param str fn: filename</span>
<span class="sd">        :return: files successfully written.</span>
<span class="sd">        :rtype: list(str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># output types must be valid!</span>
        <span class="n">fnp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">successes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">Camera</span><span class="o">.</span><span class="n">output_types</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fnp</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">np_image_array</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># set exif data</span>
                    <span class="kn">import</span> <span class="nn">pyexiv2</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">pyexiv2</span><span class="o">.</span><span class="n">ImageMetadata</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                    <span class="n">meta</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exif</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="n">meta</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Couldnt write the appropriate metadata: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">successes</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write_raw_bytes</span><span class="p">(</span><span class="n">image_bytesio</span><span class="p">:</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a BytesIO object to disk.</span>

<span class="sd">        :param image_bytesio: bytesio of an image.</span>
<span class="sd">        :param fn:</span>
<span class="sd">        :return: file name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_bytesio</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="c1"># no exif data when writing the purest bytes :-P</span>
        <span class="k">return</span> <span class="n">fn</span>

<div class="viewcode-block" id="Camera.stop"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the capture thread, if self is an instance of :class:`threading.Thread`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopper</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Camera.focus"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.focus">[docs]</a>    <span class="k">def</span> <span class="nf">focus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        AutoFocus trigger method.</span>
<span class="sd">        Unimplemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Camera.communicate_with_updater"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.communicate_with_updater">[docs]</a>    <span class="k">def</span> <span class="nf">communicate_with_updater</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inter-thread communication method.</span>
<span class="sd">        Communicates with this objects :class:`libs.Updater.Updater` by keeping a reference to its member</span>
<span class="sd">        &#39;communication_queue&#39; and appending this objects current state to the queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_name</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">failed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span>
                <span class="n">last_capture</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)))</span>
            <span class="c1"># append our data dict to the communication_queue deque.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">communication_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Inter-thread communication error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Camera.run"><a class="viewcode-back" href="../../libs.html#libs.Camera.Camera.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main method. continuously captures and stores images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopper</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="c1"># checking if enabled and other stuff</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Camera live view thread is not closed, camera lock cannot be acquired.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_to_capture</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start_capture_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">raw_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamped_imagename</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Capturing for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span>

                    <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spool_directory</span><span class="p">,</span> <span class="n">raw_image</span><span class="p">))</span>
                    <span class="c1"># capture. if capture didnt happen dont continue with the rest.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;ftp&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">):</span>
                        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">resize_t</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;ftp&quot;</span><span class="p">,</span> <span class="s2">&quot;resize&quot;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="p">(</span><span class="n">Camera</span><span class="o">.</span><span class="n">default_width</span><span class="p">,</span> <span class="n">Camera</span><span class="o">.</span><span class="n">default_height</span><span class="p">),</span>
                                                     <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">)</span>
                            <span class="n">resize_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span>

                        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">timestamped_imagename</span><span class="p">,</span>
                                    <span class="n">org</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">),</span>
                                    <span class="n">fontFace</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span>
                                    <span class="n">fontScale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                                    <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                    <span class="n">lineType</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>

                        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/dev/shm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/dev/shm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">),</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">,</span> <span class="s2">&quot;last_image.jpg&quot;</span><span class="p">))</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resize </span><span class="si">{0:.3f}</span><span class="s2">s, total: </span><span class="si">{0:.3f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resize_t</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>

                    <span class="c1"># copying/renaming for files</span>
                    <span class="n">oldfiles</span> <span class="o">=</span> <span class="n">files</span><span class="p">[:]</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">oldfiles</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="c1"># move files to the upload directory</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s2">&quot;ftp&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamped&quot;</span><span class="p">):</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Captured &amp; stored for upload - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t move for timestamped: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

                        <span class="c1"># remove the spooled files that remain</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File remaining in spool directory, removing: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t remove spooled when it still exists: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                    <span class="c1"># log total capture time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total capture time: </span><span class="si">{0:.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_capture_time</span><span class="p">))</span>
                    <span class="c1"># communicate our success with the updater</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">communicate_with_updater</span><span class="p">()</span>
                    <span class="c1"># sleep for a little bit so we dont try and capture again so soon.</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">Camera</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Image Capture error - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="IPCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.IPCamera">[docs]</a><span class="k">class</span> <span class="nc">IPCamera</span><span class="p">(</span><span class="n">Camera</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    IPCamera, unfinished and untested.</span>

<span class="sd">    TODO: needs work to support both yml config and normal configs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">communication_queue</span> <span class="o">=</span> <span class="n">queue</span> <span class="ow">or</span> <span class="n">deque</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_parser</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_parser&quot;</span><span class="p">,</span> <span class="s2">&quot;plaintext&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopper</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">camera_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;camera_name&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spool_directory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="s2">&quot;SPC-EYEPI_&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;upload_dir&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">identifier</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">)</span>

        <span class="n">start_time_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;starttime&#39;</span><span class="p">,</span> <span class="s2">&quot;00:00&quot;</span><span class="p">))</span>
        <span class="n">start_time_string</span> <span class="o">=</span> <span class="n">start_time_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">end_time_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stoptime&#39;</span><span class="p">,</span> <span class="s2">&quot;23:59&quot;</span><span class="p">))</span>
        <span class="n">end_time_string</span> <span class="o">=</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start_time_string</span> <span class="o">=</span> <span class="n">start_time_string</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="s2">&quot;Non numerical start time, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_time_string</span><span class="p">,</span> <span class="s2">&quot;%H%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Time conversion error starttime - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># cut string to max of 4.</span>
            <span class="n">end_time_string</span> <span class="o">=</span> <span class="n">end_time_string</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">end_time_string</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="s2">&quot;Non numerical end time, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_capture</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_time_string</span><span class="p">,</span> <span class="s2">&quot;%H%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Time conversion error stoptime - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Camera</span><span class="o">.</span><span class="n">default_width</span><span class="p">,</span> <span class="n">Camera</span><span class="o">.</span><span class="n">default_height</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spool_directory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;GIGAVISION&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating upload dir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Creating directories </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exif_fields</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_capture_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_notified</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">format_str</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format_url&quot;</span><span class="p">,</span> <span class="s2">&quot;http://</span><span class="si">{HTTP_login}</span><span class="s2">@</span><span class="si">{ip}{command}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">format_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">{HTTP_login}</span><span class="s2">@&quot;</span><span class="p">):</span>
            <span class="n">format_str</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{HTTP_login}</span><span class="s2">@&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">),</span>
                                             <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_HTTP_login</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_login&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{user}</span><span class="s2">:</span><span class="si">{password}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">),</span>
            <span class="n">password</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ip</span><span class="o">=</span><span class="n">ip</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.7&quot;</span><span class="p">),</span>
            <span class="n">HTTP_login</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_HTTP_login</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{command}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_image_size_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_size_list&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">],</span> <span class="p">[</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">],</span> <span class="p">[</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_size_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">image_quality</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_quality&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_quality</span> <span class="o">=</span> <span class="n">image_quality</span>
        <span class="c1"># no autofocus modes by default.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autofocus_modes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;autofocus_modes&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hfov_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizontal_fov_list&quot;</span><span class="p">,</span>
                                     <span class="p">[</span><span class="mf">71.664</span><span class="p">,</span> <span class="mf">58.269</span><span class="p">,</span> <span class="mf">47.670</span><span class="p">,</span> <span class="mf">40.981</span><span class="p">,</span> <span class="mf">33.177</span><span class="p">,</span> <span class="mf">25.246</span><span class="p">,</span> <span class="mf">18.126</span><span class="p">,</span> <span class="mf">12.782</span><span class="p">,</span> <span class="mf">9.217</span><span class="p">,</span> <span class="mf">7.050</span><span class="p">,</span>
                                      <span class="mf">5.82</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vfov_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vertical_fov_list&quot;</span><span class="p">,</span>
                                     <span class="p">[</span><span class="mf">39.469</span><span class="p">,</span> <span class="mf">33.601</span><span class="p">,</span> <span class="mf">26.508</span><span class="p">,</span> <span class="mf">22.227</span><span class="p">,</span> <span class="mf">16.750</span><span class="p">,</span> <span class="mf">13.002</span><span class="p">,</span> <span class="mf">10.324</span><span class="p">,</span> <span class="mf">7.7136</span><span class="p">,</span> <span class="mf">4.787</span><span class="p">,</span> <span class="mf">3.729</span><span class="p">,</span>
                                      <span class="mf">2.448</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hfov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vfov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zoom_list&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">650</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">850</span><span class="p">,</span> <span class="mi">950</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_focus_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;focus_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99999</span><span class="p">])</span>


        <span class="c1"># set commands from the rest of the config.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_urls</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;urls&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_keys</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_quality</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">IPCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a generic request formatting the command string and applying the authentication.</span>

<span class="sd">        :param command_string: command string like read stream raw</span>
<span class="sd">        :type command_string: str</span>
<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command_string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;&amp;&quot;</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">and</span> <span class="s2">&quot;?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Some exception got raised </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">204</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] - </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)))</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">_read_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        opens a url with the current HTTP_login string</span>
<span class="sd">        :type command_string: str</span>
<span class="sd">        :param command_string: url to go to with parameters</span>
<span class="sd">        :return: string of data returned from the camera</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">command_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>

    <span class="k">def</span> <span class="nf">_read_stream_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        opens a url with the current HTTP_login string</span>

<span class="sd">        :param command_string: url to go to with parameters</span>
<span class="sd">        :type command_string: str</span>
<span class="sd">        :return: string of data returned from the camera</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">command_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>

    <span class="k">def</span> <span class="nf">_get_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_urls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd_str</span> <span class="ow">and</span> <span class="n">cmd_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notified</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No command available for </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notified</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">keys</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="IPCamera.get_value_from_xml"><a class="viewcode-back" href="../../libs.html#libs.Camera.IPCamera.get_value_from_xml">[docs]</a>    <span class="k">def</span> <span class="nf">get_value_from_xml</span><span class="p">(</span><span class="n">message_xml</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets float, int or string values from a xml string where the key is the tag of the first element with value as</span>
<span class="sd">        text.</span>

<span class="sd">        :param message_xml: the xml to searach in.</span>
<span class="sd">        :param args: list of keys to find values for.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        :return: dict of arg: value pairs requested</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">return_values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">message_xml</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">return_values</span>
        <span class="c1"># apparently, there is an issue parsing when the ptz returns INVALID XML (WTF?)</span>
        <span class="c1"># these seem to be the tags that get mutilated.</span>
        <span class="n">illegal</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span>
                   <span class="sa">b</span><span class="s2">&quot;&lt;CPStatusMsg&gt;&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&lt;/CPStatusMsg&gt;&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&lt;Text&gt;&quot;</span><span class="p">,</span>
                   <span class="sa">b</span><span class="s2">&quot;&lt;/Text&gt;&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&lt;Type&gt;Info&lt;/Type&gt;&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&lt;Type&gt;Info&quot;</span><span class="p">,</span>
                   <span class="sa">b</span><span class="s2">&quot;Info&lt;/Type&gt;&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&lt;/Type&gt;&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&lt;Type&gt;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ill</span> <span class="ow">in</span> <span class="n">illegal</span><span class="p">:</span>
            <span class="n">message_xml</span> <span class="o">=</span> <span class="n">message_xml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ill</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">root_element</span> <span class="o">=</span> <span class="n">ElementTree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;invalidation_tag&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root_element</span> <span class="o">=</span> <span class="n">ElementTree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">message_xml</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldnt parse XML!!!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message_xml</span><span class="p">)</span>

        <span class="n">return_values</span> <span class="o">=</span> <span class="nb">dict</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">target_ele</span> <span class="o">=</span> <span class="n">root_element</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target_ele</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">target_ele</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">return_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldnt cast an xml element text attribute to str. What are you feeding the xml parser?&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">return_values</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="IPCamera.get_value_from_plaintext"><a class="viewcode-back" href="../../libs.html#libs.Camera.IPCamera.get_value_from_plaintext">[docs]</a>    <span class="k">def</span> <span class="nf">get_value_from_plaintext</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets float, int or string values from a xml string where the key is the tag of the first element with value as</span>
<span class="sd">        text.</span>

<span class="sd">        :param message:</span>
<span class="sd">        :param args: list of keys to find values for.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        :return: dict of arg: value pairs requested</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">return_values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">return_values</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;= &quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; =&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">]:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">]</span>
                        <span class="n">return_values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldnt cast an plaintext element text attribute to str. What are you feeding the parser?&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_values</span></div>

<div class="viewcode-block" id="IPCamera.get_value_from_stream"><a class="viewcode-back" href="../../libs.html#libs.Camera.IPCamera.get_value_from_stream">[docs]</a>    <span class="k">def</span> <span class="nf">get_value_from_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a value from some text data (xml or plaintext = separated values)</span>
<span class="sd">        returns a dict of &quot;key&quot;:value pairs.</span>

<span class="sd">        :param stream: text data to search for values</span>
<span class="sd">        :type stream: str</span>
<span class="sd">        :param keys:</span>
<span class="sd">        :type keys: list</span>
<span class="sd">        :return: dict of values</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_parser</span> <span class="o">==</span> <span class="s1">&#39;plaintext&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_plaintext</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_parser</span> <span class="o">==</span> <span class="s1">&#39;xml&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_xml</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPCamera.capture_image"><a class="viewcode-back" href="../../libs.html#libs.Camera.IPCamera.capture_image">[docs]</a>    <span class="k">def</span> <span class="nf">capture_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Captures an image with the IP camera, uses requests.get to acqire the image.</span>

<span class="sd">        :param filename: filename without extension to capture to.</span>
<span class="sd">        :return: list of filenames (of captured images) if filename was specified, otherwise a numpy array of the image.</span>
<span class="sd">        :rtype: numpy.array or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;get_image&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{width}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="si">{height}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No capture command, this is wrong...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># fast method</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream_raw</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">rfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_write_np_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">rfiles</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Capture from network camera failed </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;All capture attempts (10) for network camera failed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span></div>

    <span class="c1"># def set_fov_from_zoom(self):</span>
    <span class="c1">#     self._hfov = numpy.interp(self._zoom_position, self.zoom_list, self.hfov_list)</span>
    <span class="c1">#     self._vfov = numpy.interp(self._zoom_position, self.zoom_list, self.vfov_list)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Image quality as a percentage.</span>

<span class="sd">        :getter: cached.</span>
<span class="sd">        :setter: to camera.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_quality</span>

    <span class="nd">@image_quality</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">image_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;get_image_quality&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Image resolution in pixels, tuple of (width, height)</span>

<span class="sd">        :getter: from camera.</span>
<span class="sd">        :setter: to camera.</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;get_image_size&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
            <span class="n">width</span><span class="p">,</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_size</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;width&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="s2">&quot;height&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">v</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_size</span>

    <span class="nd">@image_size</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">image_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;image size is not a list or tuple!&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;image size doesnt have 2 elements width,height are required&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_size_list</span><span class="p">,</span> <span class="s2">&quot;image size not in available image sizes&quot;</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;set_image_size&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image_size</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">focus_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: this is broken, returns the dict of key: value not value</span>

<span class="sd">        Focus Mode</span>

<span class="sd">        When setting, the mode provided must be in &#39;focus_modes&#39;</span>

<span class="sd">        :getter: from camera.</span>
<span class="sd">        :setter: to camera.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;get_focus_mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">stream_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_stream</span><span class="p">(</span><span class="n">stream_output</span><span class="p">,</span> <span class="n">keys</span><span class="p">)[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>

    <span class="nd">@focus_mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">focus_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_autofocus_modes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autofocus_modes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Focus mode not in list of supported focus modes. YMMV.&quot;</span><span class="p">)</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;set_focus_mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">focus_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Focal position as an absolute value.</span>

<span class="sd">        :getter: from camera.</span>
<span class="sd">        :setter: to camera.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;get_focus&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">stream_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_stream</span><span class="p">(</span><span class="n">stream_output</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="mi">99999</span><span class="p">))</span>

    <span class="nd">@focus_position</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">focus_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">absolute_position</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting focus position to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">absolute_position</span><span class="p">))</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;set_focus&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_focus_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">absolute_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">absolute_position</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_focus_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_focus_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">absolute_position</span><span class="p">))</span>
            <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_focus_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">absolute_position</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_focus_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">focus</span><span class="o">=</span><span class="n">absolute_position</span><span class="p">))</span>

<div class="viewcode-block" id="IPCamera.focus"><a class="viewcode-back" href="../../libs.html#libs.Camera.IPCamera.focus">[docs]</a>    <span class="k">def</span> <span class="nf">focus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        focuses the camera by cycling it through its autofocus modes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Focusing...&quot;</span><span class="p">)</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;set_autofocus_mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_autofocus_modes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autofocus_modes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">focus_mode</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_autofocus_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Focus complete.&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">focus_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Information about the focus of the camera</span>

<span class="sd">        :return: focus type, focus max, focus min</span>
<span class="sd">        :rtype: list [str, float, float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cmd</span><span class="p">(</span><span class="s2">&quot;get_focus_range&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">stream_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stream</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_stream</span><span class="p">(</span><span class="n">stream_output</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hfov_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of horizontal FoV values according to focus list.</span>

<span class="sd">        :getter: cached.</span>
<span class="sd">        :setter: cache.</span>
<span class="sd">        :rrtype: list(float)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hfov_list</span>

    <span class="nd">@hfov_list</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">hfov_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;must be either list or tuple&quot;</span>
        <span class="c1"># assert len(value) == len(self._zoom_list), &quot;must be the same length as zoom list&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hfov_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vfov_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of vertical FoV values according to focus list.</span>

<span class="sd">        :getter: cached.</span>
<span class="sd">        :setter: cache.</span>
<span class="sd">        :rrtype: list(float)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vfov_list</span>

    <span class="nd">@vfov_list</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vfov_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;must be either list or tuple&quot;</span>
        <span class="c1"># assert len(value) == len(self._zoom_list), &quot;must be the same length as zoom list&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vfov_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hfov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Horizontal FoV</span>

<span class="sd">        :getter: calculated using cached zoom_position, zoom_list and hfov_list.</span>
<span class="sd">        :setter: cache.</span>
<span class="sd">        :rrtype: list(float)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self._hfov = numpy.interp(self._zoom_position, self.zoom_list, self.hfov_list)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hfov</span>

    <span class="nd">@hfov</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">hfov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hfov</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vfov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vertical FoV</span>

<span class="sd">        :getter: calculated using cached zoom_position, zoom_list and vfov_list.</span>
<span class="sd">        :setter: cache.</span>
<span class="sd">        :rrtype: list(float)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self._vfov = numpy.interp(self._zoom_position, self.zoom_list, self.vfov_list)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vfov</span>

    <span class="nd">@vfov</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vfov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vfov</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper property for a string of the current zoom/focus status.</span>

<span class="sd">        :return: informative string of zoom_pos zoom_range focus_pos focus_range</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># fmt_string = &quot;zoom_pos:\t{}\nzoom_range:\t{}&quot;</span>
        <span class="n">fmt_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">focus_pos:</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">focus_range:</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fmt_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">focus_position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_range</span><span class="p">)</span></div>

    <span class="c1"># def focus(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     forces a refocus of the the camera</span>
    <span class="c1">#</span>
    <span class="c1">#     :return: response from the camera.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     cmd,keys = self._get_cmd(&quot;set_focus_mode&quot;)</span>
    <span class="c1">#     if not cmd:</span>
    <span class="c1">#         return None</span>
    <span class="c1">#     stream_output = self._read_stream(cmd.format(mode=&quot;REFOCUS&quot;))</span>
    <span class="c1">#     return self.get_value_from_stream(stream_output, keys)</span>


<div class="viewcode-block" id="GPCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.GPCamera">[docs]</a><span class="k">class</span> <span class="nc">GPCamera</span><span class="p">(</span><span class="n">Camera</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Camera class</span>
<span class="sd">    other cameras inherit from this class.</span>
<span class="sd">    identifier and usb_address are NOT OPTIONAL</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="n">Lock</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serialnumber</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usb_address</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GPCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;camera&#39;</span><span class="p">,</span> <span class="s2">&quot;exposure&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GPCamera.re_init"><a class="viewcode-back" href="../../libs.html#libs.Camera.GPCamera.re_init">[docs]</a>    <span class="k">def</span> <span class="nf">re_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        re initialises the camera.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GPCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">re_init</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">serialnumber</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">camera</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">gp</span><span class="o">.</span><span class="n">list_cameras</span><span class="p">():</span>
                    <span class="n">serialnumber</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">serialnumber</span>
                    <span class="k">if</span> <span class="n">serialnumber</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
                        <span class="n">camera</span> <span class="o">=</span> <span class="n">cam</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Camera not available or connected&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">gp</span><span class="o">.</span><span class="n">list_cameras</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">serialnumber</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">serialnumber</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">SysUtil</span><span class="o">.</span><span class="n">default_identifier</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">serialnumber</span><span class="p">)</span>
                        <span class="n">camera</span> <span class="o">=</span> <span class="n">cam</span>
                        <span class="k">break</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;No cameras available&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">usb_address</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="n">_usb_address</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_serialnumber</span> <span class="o">=</span> <span class="n">serialnumber</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Camera detected at usb port </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">usb_address</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;exposure&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GPCamera.get_exif_fields"><a class="viewcode-back" href="../../libs.html#libs.Camera.GPCamera.get_exif_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_exif_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is meant to get the exif fields for the image if we want to manually save them.</span>
<span class="sd">        This is incomplete.</span>

<span class="sd">        :return: dictionary of exif fields.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exif</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GPCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_exif_fields</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">camera</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_camera</span><span class="p">()</span>
            <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Image.Make&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">camera</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;manufacturer&#39;</span><span class="p">,</span> <span class="s1">&#39;Make&#39;</span><span class="p">)</span>
            <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Image.Model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">camera</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;cameramodel&#39;</span><span class="p">,</span> <span class="s1">&#39;Model&#39;</span><span class="p">)</span>
            <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Image.BodySerialNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_serial_number</span>
            <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Image.CameraSerialNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_number</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Photo.ISOSpeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;iso&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;Exif.Photo.Aperture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldnt get full exif data. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">exif</span></div>

    <span class="k">def</span> <span class="nf">_get_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">camera</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">Camera</span><span class="p">(</span><span class="n">bus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usb_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usb_address</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialnumber</span> <span class="o">==</span> <span class="n">camera</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">serialnumber</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Camera matched for </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">usb_address</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">camera</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Camera wasnt at the correct usb address or something: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="n">gp</span><span class="o">.</span><span class="n">list_cameras</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">camera</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">serialnumber</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialnumber</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">camera</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Couldnt acquire lock for camera. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Camera cannot be found&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GPCamera.capture_image"><a class="viewcode-back" href="../../libs.html#libs.Camera.GPCamera.capture_image">[docs]</a>    <span class="k">def</span> <span class="nf">capture_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gapture method for DSLRs.</span>
<span class="sd">        Some contention exists around this method, as its definitely not the easiest thing to have operate robustly.</span>
<span class="sd">        :func:`GPCamera._cffi_capture` is how it _should_ be done, however that method is unreliable and causes many</span>
<span class="sd">        crashes when in real world timelapse situations.</span>
<span class="sd">        This method calls gphoto2 directly, which makes us dependent on gphoto2 (not just libgphoto2 and gphoto2-cffi),</span>
<span class="sd">        and there is probably some issue with calling gphoto2 at the same time like 5 times, maybe dont push it.</span>

<span class="sd">        :param filename: filename without extension to capture to.</span>
<span class="sd">        :return: list of filenames (of captured images) if filename was specified, otherwise a numpy array of the image.</span>
<span class="sd">        :rtype: numpy.array or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="kn">import</span> <span class="nn">glob</span>

        <span class="c1"># the %C filename parameter given to gphoto2 will automatically expand the number of image types that the</span>
        <span class="c1"># camera is set to capture to.</span>

        <span class="c1"># this one shouldnt really be used.</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-temp.%C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="c1"># if target file path exists</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spool_directory</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.%C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;gphoto2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--port=usb:</span><span class="si">{bus:03d}</span><span class="s2">,</span><span class="si">{dev:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usb_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usb_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;--set-config=capturetarget=0&quot;</span><span class="p">,</span>  <span class="c1"># capture to sdram</span>
            <span class="s2">&quot;--force-overwrite&quot;</span><span class="p">,</span>  <span class="c1"># if the target image exists. If this isnt present gphoto2 will lock up asking</span>
            <span class="s2">&quot;--capture-image-and-download&quot;</span><span class="p">,</span>  <span class="c1"># must capture &amp; download in the same call to use sdram target.</span>
            <span class="s1">&#39;--filename=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Capture start: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tries</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CMD: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">(</span><span class="s2">&quot;non-zero exit status&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># log success of capture</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GPCamera capture success: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;GPHOTO2: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                    <span class="c1"># glob up captured images</span>
                    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%C&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
                    <span class="c1"># if there are no captured images, log the error</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;capture resulted in no files.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># try and load an image for the last_image.jpg resized doodadery</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">first</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">filenames</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to set current image: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

                        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                            <span class="c1"># return the filenames of the spooled images if files were requestsed.</span>
                            <span class="k">return</span> <span class="n">filenames</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># otherwise remove the temporary files that we created in order to fill self._image</span>
                            <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                            <span class="c1"># and return self._image</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span>

            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;failed </span><span class="si">{}</span><span class="s2"> times&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tries</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="s2">&quot;***&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Really bad stuff happened. too many tries capturing.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_cffi_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        old cffi capture. very unreliable.</span>
<span class="sd">        Causes a memory leak somewhere that I cant find.</span>

<span class="sd">        :param filename: filename without extension to capture to.</span>
<span class="sd">        :return: list of filenames (of captured images) if filename was specified, otherwise a numpy array of the image.</span>
<span class="sd">        :rtype: numpy.array or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">camera</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_camera</span><span class="p">()</span>
                <span class="n">successes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">camera</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">img_expect_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">))):</span>
                    <span class="k">with</span> <span class="n">image</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">size</span> <span class="o">+=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span>
                                <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
                            <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                            <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">image</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Couldnt remove image for some reason (probably already gone)&quot;</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">image</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Captured and stored: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="c1"># cant do anything if failure here.</span>
                            <span class="k">pass</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Filesize </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">successes</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error Capturing with DSLR: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">camera</span><span class="p">:</span>
                    <span class="n">camera</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;(10) Tries capturing failed&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">(</span><span class="n">item</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">serial_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the current serialnumber for the camera.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialnumber</span>

<div class="viewcode-block" id="GPCamera.focus"><a class="viewcode-back" href="../../libs.html#libs.Camera.GPCamera.focus">[docs]</a>    <span class="k">def</span> <span class="nf">focus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this is meant to trigger the autofocus. currently not in use because it causes some distortion in the images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_camera</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="c1"># camera._get_config()[&#39;actions&#39;][&#39;eosremoterelease&#39;].set(&quot;Release Full&quot;)</span>
            <span class="c1"># camera._get_config()[&#39;actions&#39;][&#39;eosremoterelease&#39;].set(&quot;Press 1&quot;)</span>
            <span class="c1"># camera._get_config()[&#39;actions&#39;][&#39;eosremoterelease&#39;].set(&quot;Release Full&quot;)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eos_serial_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the eosserialnumber of supported cameras, otherwise the normal serialnumber</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_camera</span><span class="p">()</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">camera</span><span class="o">.</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eosserialnumber&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_number</span><span class="p">)</span>
        <span class="n">camera</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sn</span>

    <span class="k">def</span> <span class="nf">_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        searches for a field from the camera config.</span>

<span class="sd">        :param field: string to search</span>
<span class="sd">        :return: list of matching fields, should mostly be len 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields_found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_camera</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="n">_get_config</span><span class="p">()</span>
        <span class="n">camera</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">nested_lookup</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span></div>


<div class="viewcode-block" id="USBCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.USBCamera">[docs]</a><span class="k">class</span> <span class="nc">USBCamera</span><span class="p">(</span><span class="n">Camera</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    USB Camera Class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="USBCamera.stream_thread"><a class="viewcode-back" href="../../libs.html#libs.Camera.USBCamera.stream_thread">[docs]</a>    <span class="k">def</span> <span class="nf">stream_thread</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        usb camera stream thread.</span>
<span class="sd">        TODO: Needs to be aware of multiple cameras.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ThreadStartup ...&quot;</span><span class="p">)</span>
        <span class="n">cam</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">()</span>

        <span class="c1"># camera setup</span>
        <span class="c1"># let camera warm up</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">cam</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span>
        <span class="n">cam</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Started up!&quot;</span><span class="p">)</span>
        <span class="c1"># for foo in camera.capture_continuous(stream, &#39;jpeg&#39;,</span>
        <span class="c1">#                                      use_video_port=True):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imencode</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
            <span class="c1"># store frame</span>

            <span class="c1"># if there hasn&#39;t been any clients asking for frames in</span>
            <span class="c1"># the last 10 seconds stop the thread</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_last_access</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ThreadShutdown&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">sys_number</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        USB camera init. must have a sys_number (the 0 from /dev/video0) to capture from</span>

<span class="sd">        :param identifier: identifier for the webcamera</span>
<span class="sd">        :param sys_number: system device number of device to use</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># only webcams have a v4l sys_number.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys_number</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;couldnt open video capture device on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_number</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">USBCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="USBCamera.re_init"><a class="viewcode-back" href="../../libs.html#libs.Camera.USBCamera.re_init">[docs]</a>    <span class="k">def</span> <span class="nf">re_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        re-initialisation of webcamera</span>
<span class="sd">        todo: fix release of camera otherwise it gets locked forever.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">USBCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">re_init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_capture_device</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_number</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;Couldnt open a video capture device on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_number</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;Couldnt open a video capture device&quot;</span><span class="p">)</span>
        <span class="c1"># 3 -&gt; width 4-&gt;height 5-&gt;fps just max them out to get the highest resolution.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Capturing at </span><span class="si">{w}</span><span class="s2">x</span><span class="si">{h}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">),</span>
                                                       <span class="n">h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">)))</span></div>

<div class="viewcode-block" id="USBCamera.stop"><a class="viewcode-back" href="../../libs.html#libs.Camera.USBCamera.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        releases the video device and stops the camera thread</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldnt release cv2 device </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopper</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_assert_capture_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ensures the capture device is open and valid.</span>

<span class="sd">        :param self:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_number</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;VideoCapture().open(</span><span class="si">{}</span><span class="s2">) failed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_number</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Capture device could not be opened </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

<div class="viewcode-block" id="USBCamera.capture_image"><a class="viewcode-back" href="../../libs.html#libs.Camera.USBCamera.capture_image">[docs]</a>    <span class="k">def</span> <span class="nf">capture_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        captures an image from the usb webcam.</span>
<span class="sd">        Writes some limited exif data to the image if it can.</span>

<span class="sd">        :param filename: filename to output without excension</span>
<span class="sd">        :return: list of image filenames if filename was specified, otherwise a numpy array.</span>
<span class="sd">        :rtype: numpy.array or list</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_capture</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">im</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error webcam capture did not read </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filenames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_write_np_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">filenames</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not write image </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="PiCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.PiCamera">[docs]</a><span class="k">class</span> <span class="nc">PiCamera</span><span class="p">(</span><span class="n">Camera</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Picamera extension to the Camera abstract class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PiCamera.stream_thread"><a class="viewcode-back" href="../../libs.html#libs.Camera.PiCamera.stream_thread">[docs]</a>    <span class="k">def</span> <span class="nf">stream_thread</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Streaming thread member.</span>

<span class="sd">        uses :func:`picamera.PiCamera.capture_continuous` to stream data from the rpi camera video port.</span>

<span class="sd">        :func:`time.sleep` added to rate limit a little bit.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">picamera</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start thread&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">picamera</span><span class="o">.</span><span class="n">PiCamera</span><span class="p">()</span> <span class="k">as</span> <span class="n">camera</span><span class="p">:</span>
                <span class="c1"># camera setup</span>
                <span class="n">camera</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>
                <span class="c1"># camera.hflip = True</span>
                <span class="c1"># camera.vflip = True</span>

                <span class="c1"># let camera warm up</span>
                <span class="n">camera</span><span class="o">.</span><span class="n">start_preview</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">stream</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">foo</span> <span class="ow">in</span> <span class="n">camera</span><span class="o">.</span><span class="n">capture_continuous</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span>
                                                     <span class="n">use_video_port</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="c1"># store frame</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_frame</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                    <span class="c1"># reset stream for next frame</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>

                    <span class="c1"># if there hasn&#39;t been any clients asking for frames in</span>
                    <span class="c1"># the last 10 seconds stop the thread</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_last_access</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldnt acquire camera&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closing Thread&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PiCamera.set_camera_settings"><a class="viewcode-back" href="../../libs.html#libs.Camera.PiCamera.set_camera_settings">[docs]</a>    <span class="k">def</span> <span class="nf">set_camera_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the camera resolution to the max resolution</span>

<span class="sd">        if the config provides camera/height or camera/width attempts to set the resolution to that.</span>
<span class="sd">        if the config provides camera/isoattempts to set the iso to that.</span>
<span class="sd">        if the config provides camera/shutter_speed to set the shutterspeed to that.</span>

<span class="sd">        :param picamera.PiCamera camera: picamera camera instance to modify</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">camera</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="n">MAX_RESOLUTION</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">):</span>
                <span class="n">camera</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;shutter_speed&quot;</span><span class="p">):</span>
                <span class="n">camera</span><span class="o">.</span><span class="n">shutter_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;shutter_speed&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;iso&quot;</span><span class="p">):</span>
                <span class="n">camera</span><span class="o">.</span><span class="n">iso</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s2">&quot;camera&quot;</span><span class="p">,</span> <span class="s2">&quot;iso&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;error setting picamera settings: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div>

<div class="viewcode-block" id="PiCamera.capture_image"><a class="viewcode-back" href="../../libs.html#libs.Camera.PiCamera.capture_image">[docs]</a>    <span class="k">def</span> <span class="nf">capture_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Captures image using the Raspberry Pi Camera Module, at either max resolution, or resolution</span>
<span class="sd">        specified in the config file.</span>

<span class="sd">        Writes images disk using :func:`encode_write_np_array`, so it should write out to all supported image formats</span>
<span class="sd">        automatically.</span>

<span class="sd">        :param filename: image filename without extension</span>
<span class="sd">        :return: :func:`numpy.array` if filename not specified, otherwise list of files.</span>
<span class="sd">        :rtype: numpy.array or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">picamera</span><span class="o">.</span><span class="n">PiCamera</span><span class="p">()</span> <span class="k">as</span> <span class="n">camera</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">picamera</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">PiRGBArray</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Camera warm-up time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_camera_settings</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">camera</span><span class="o">.</span><span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">camera</span><span class="o">.</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="n">camera</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s1">&#39;rgb&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">array</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">filenames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_write_np_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">filenames</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;EPIC FAIL, trying other method. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span></div></div>


<div class="viewcode-block" id="IVPortCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.IVPortCamera">[docs]</a><span class="k">class</span> <span class="nc">IVPortCamera</span><span class="p">(</span><span class="n">PiCamera</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    IVPort class for multiple capture.</span>
<span class="sd">    the 4 tags on the IVport are setout below.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_camera_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># these are for the video streaming</span>
    <span class="n">select</span> <span class="o">=</span> <span class="mi">7</span>

    <span class="n">enable_pins</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">],</span>
        <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="n">TRUTH_TABLE</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span>  <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>  <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>  <span class="kc">False</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">gpio_groups</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,)</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">queue</span><span class="p">:</span> <span class="n">deque</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">gpio_group</span><span class="p">:</span> <span class="nb">tuple</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,),</span>
                 <span class="n">camera_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        special __init__ for the IVport to set the gpio enumeration</span>
<span class="sd">        This controls which gpio are on or off to select the camera and whcih camera group has been soldered on the</span>
<span class="sd">        ivport. Multiple camera groups can be specified, and they will be enumerated in alphabetical order.</span>

<span class="sd">        :param identifier: string identifier for the camera</span>
<span class="sd">        :type identifier: str</span>
<span class="sd">        :param queue: communication queue for the camera to communicate with the updater</span>
<span class="sd">        :type queue: deque</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">gpio_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gpio_group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">camera_number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">IVPortCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">current_camera_index</span> <span class="o">=</span> <span class="n">camera_number</span>
            <span class="n">IVPortCamera</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">current_camera_index</span><span class="p">)</span>

<div class="viewcode-block" id="IVPortCamera.setup"><a class="viewcode-back" href="../../libs.html#libs.Camera.IVPortCamera.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets up gpio for IVPort</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IVPortCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="c1"># switch to the current camera index.</span>
        <span class="n">IVPortCamera</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">current_camera_index</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="IVPortCamera.switch"><a class="viewcode-back" href="../../libs.html#libs.Camera.IVPortCamera.switch">[docs]</a>    <span class="k">def</span> <span class="nf">switch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        switches the IVPort to a new camera</span>
<span class="sd">        with no index, switches to the next camera, looping around from the beginning</span>

<span class="sd">        :param idx: index to switch the camera to (optional)</span>
<span class="sd">        :type idx: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># import RPi.GPIO as GPIO</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">current_camera_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">current_camera_index</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">current_camera_index</span> <span class="o">%=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IVPortCamera</span><span class="o">.</span><span class="n">TRUTH_TABLE</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">gpio_groups</span><span class="p">))</span>
        <span class="c1"># GPIO.setwarnings(False)</span>
        <span class="c1"># GPIO.setmode(GPIO.BOARD)</span>
        <span class="c1"># GPIO.setup(IVPortCamera.select, GPIO.OUT)</span>

        <span class="c1"># current groups determined by the camera index / number of cameras per board (truth table len)</span>
        <span class="n">current_group</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">gpio_groups</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">current_camera_index</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">IVPortCamera</span><span class="o">.</span><span class="n">TRUTH_TABLE</span><span class="p">))]</span>
        <span class="n">current_pins</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">enable_pins</span><span class="p">[</span><span class="n">current_group</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Switching to camera </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_group</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">current_camera_index</span><span class="p">))</span>

        <span class="c1"># GPIO.setup(current_pins[0], GPIO.OUT)</span>
        <span class="c1"># GPIO.setup(current_pins[1], GPIO.OUT)</span>

        <span class="c1"># per camera index, current camera index mod the number of cameras per board</span>
        <span class="n">truth_table_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">current_camera_index</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">IVPortCamera</span><span class="o">.</span><span class="n">TRUTH_TABLE</span><span class="p">)</span>

        <span class="n">pin_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">IVPortCamera</span><span class="o">.</span><span class="n">TRUTH_TABLE</span><span class="p">[</span><span class="n">truth_table_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">IVPortCamera</span><span class="o">.</span><span class="n">TRUTH_TABLE</span><span class="p">[</span><span class="n">truth_table_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">IVPortCamera</span><span class="o">.</span><span class="n">TRUTH_TABLE</span><span class="p">[</span><span class="n">truth_table_idx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># GPIO.output(IVPortCamera.select, pin_values[0])</span>
        <span class="c1"># GPIO.output(IVPortCamera.enable_pins[0], pin_values[1])</span>
        <span class="c1"># GPIO.output(IVPortCamera.enable_pins[1], pin_values[2])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pin_values</span><span class="p">)</span></div>

<div class="viewcode-block" id="IVPortCamera.capture_image"><a class="viewcode-back" href="../../libs.html#libs.Camera.IVPortCamera.capture_image">[docs]</a>    <span class="k">def</span> <span class="nf">capture_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        capture method for IVPort</span>
<span class="sd">        iterates over the number of vameras</span>

<span class="sd">        :return: :func:`numpy.array` if filename not specified, otherwise list of files.</span>
<span class="sd">        :rtype: numpy.array or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">picamera</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">picamera</span><span class="o">.</span><span class="n">PiCamera</span><span class="p">()</span> <span class="k">as</span> <span class="n">camera</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">picamera</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">PiRGBArray</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span> <span class="k">as</span> <span class="n">_image</span><span class="p">:</span>
                    <span class="n">camera</span><span class="o">.</span><span class="n">start_preview</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Camera warm-up time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_camera_settings</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span>
                    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="n">resolution</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">IVPortCamera</span><span class="o">.</span><span class="n">TRUTH_TABLE</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">IVPortCamera</span><span class="o">.</span><span class="n">TRUTH_TABLE</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ast</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            <span class="n">IVPortCamera</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                            <span class="n">camera</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">_image</span><span class="p">,</span> <span class="s1">&#39;rgb&#39;</span><span class="p">)</span>
                            <span class="c1"># _image = numpy.empty((camera.resolution[1], camera.resolution[0], 3), dtype=numpy.uint8)</span>

                            <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                                <span class="n">image_numbered</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">),</span>
                                                                  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode_write_np_array</span><span class="p">(</span><span class="n">_image</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">image_numbered</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture image #</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ast</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span>

                            <span class="c1"># setup the images</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">w</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">_image</span><span class="o">.</span><span class="n">array</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Couldnt capture (IVPORT) with camera </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                        <span class="n">_image</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{0:.2f}</span><span class="s2">s to capture all images&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ast</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">filenames</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldnt acquire picam: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Threaded implementations</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="ThreadedCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedCamera">[docs]</a><span class="k">class</span> <span class="nc">ThreadedCamera</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">):</span>
            <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Threaded startup&quot;</span><span class="p">)</span>
        <span class="c1"># super(self.__class__, self).__init__(*args, **kwargs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;config_filename&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;re_init&quot;</span><span class="p">):</span>
            <span class="n">SysUtil</span><span class="p">()</span><span class="o">.</span><span class="n">add_watch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_init</span><span class="p">)</span></div>


<div class="viewcode-block" id="ThreadedGPCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedGPCamera">[docs]</a><span class="k">class</span> <span class="nc">ThreadedGPCamera</span><span class="p">(</span><span class="n">ThreadedCamera</span><span class="p">,</span> <span class="n">GPCamera</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">GPCamera</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadedGPCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedGPCamera.run"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedGPCamera.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GPCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ThreadedIPCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedIPCamera">[docs]</a><span class="k">class</span> <span class="nc">ThreadedIPCamera</span><span class="p">(</span><span class="n">ThreadedCamera</span><span class="p">,</span> <span class="n">IPCamera</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">IPCamera</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadedIPCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedIPCamera.run"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedIPCamera.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IPCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ThreadedUSBCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedUSBCamera">[docs]</a><span class="k">class</span> <span class="nc">ThreadedUSBCamera</span><span class="p">(</span><span class="n">ThreadedCamera</span><span class="p">,</span> <span class="n">USBCamera</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">USBCamera</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadedUSBCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedUSBCamera.run"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedUSBCamera.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">USBCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ThreadedPiCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedPiCamera">[docs]</a><span class="k">class</span> <span class="nc">ThreadedPiCamera</span><span class="p">(</span><span class="n">ThreadedCamera</span><span class="p">,</span> <span class="n">PiCamera</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">PiCamera</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadedPiCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedPiCamera.run"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedPiCamera.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PiCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ThreadedIVPortCamera"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedIVPortCamera">[docs]</a><span class="k">class</span> <span class="nc">ThreadedIVPortCamera</span><span class="p">(</span><span class="n">ThreadedCamera</span><span class="p">,</span> <span class="n">IVPortCamera</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">IVPortCamera</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadedIVPortCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadedIVPortCamera.run"><a class="viewcode-back" href="../../libs.html#libs.Camera.ThreadedIVPortCamera.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IVPortCamera</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016, Gareth Dunstone, Kevin Murray, Tim Brown.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>